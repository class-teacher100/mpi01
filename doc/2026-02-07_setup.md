# Windows環境でのMS-MPI + MSVC + GMPセットアップ手順

作成日: 2026-02-07

## 概要

Windows上でBBP公式による並列円周率計算プログラム (`pi_bbp_mpi.c`) をビルド・実行するための環境構築手順。

## 前提環境

| コンポーネント | バージョン | 状態 |
|---|---|---|
| OS | Windows 10/11 (x64) | インストール済み |
| Visual Studio 2022 Community | MSVC v19.43 | インストール済み |
| MS-MPI ランタイム | - | インストール済み |
| MS-MPI SDK | - | インストール済み |
| MSYS2 MINGW64 | - | インストール済み（任意） |

### MS-MPI インストール確認

ランタイム:
```
C:\Program Files\Microsoft MPI\Bin\mpiexec.exe
```

SDK（ヘッダ・ライブラリ）:
```
C:\Program Files (x86)\Microsoft SDKs\MPI\Include\mpi.h
C:\Program Files (x86)\Microsoft SDKs\MPI\Lib\x64\msmpi.lib
```

## 必要な追加コンポーネント: GMP ライブラリ

`pi_bbp_mpi.c` は多倍長精度演算ライブラリ GMP (`gmp.h`) を使用するため、別途インストールが必要。

### インストール方法の比較

| | 方法A: vcpkg（採用） | 方法B: MSYS2 pacman |
|---|---|---|
| 手順 | git clone + bootstrap + vcpkg install | `pacman -S mingw-w64-x86_64-gmp` |
| 所要時間 | 5〜10分以上（ソースからビルド） | 数十秒（ビルド済みバイナリ） |
| MSVCとの互換性 | 完全互換 | `.dll.a` 形式のため追加対応が必要な場合あり |

MSVCとの互換性を考慮し、**方法A（vcpkg）** を採用。

### vcpkg による GMP インストール手順

```cmd
:: vcpkgのクローンとブートストラップ
git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
C:\vcpkg\bootstrap-vcpkg.bat

:: GMPのインストール（x64-windows）
C:\vcpkg\vcpkg install gmp:x64-windows
```

### インストール結果の確認

インストール後、以下のファイルが配置される:

```
C:\vcpkg\installed\x64-windows\
├── include\
│   ├── gmp.h          # ヘッダファイル
│   └── gmpxx.h
├── lib\
│   ├── gmp.lib         # リンクライブラリ
│   └── gmpxx.lib
└── bin\
    ├── gmp-10.dll       # ランタイムDLL
    └── gmpxx-4.dll
```

## ビルド手順

**Developer Command Prompt for VS 2022** を開いて実行する（通常の `cmd.exe` や MSYS2 シェルでは `cl.exe` にパスが通っていない）。

### コンパイルコマンド

```cmd
cd C:\Users\cre\mpi01

cl /O2 /utf-8 pi_bbp_mpi.c ^
  /I"C:\Program Files (x86)\Microsoft SDKs\MPI\Include" ^
  /I"C:\vcpkg\installed\x64-windows\include" ^
  /link ^
  /LIBPATH:"C:\Program Files (x86)\Microsoft SDKs\MPI\Lib\x64" msmpi.lib ^
  /LIBPATH:"C:\vcpkg\installed\x64-windows\lib" gmp.lib
```

### コンパイルオプションの説明

| オプション | 説明 |
|---|---|
| `/O2` | 最適化（速度優先） |
| `/utf-8` | ソースファイルと実行時文字列リテラルをUTF-8として扱う |
| `/I"..."` | インクルードパス（MS-MPI SDK、vcpkg GMP） |
| `/LIBPATH:"..."` | ライブラリ検索パス |
| `msmpi.lib` | MS-MPIリンクライブラリ |
| `gmp.lib` | GMPリンクライブラリ |

### `/utf-8` フラグについて

このフラグを付けないと、MSVCがソースファイルをShift-JIS（CP932）として解釈し、UTF-8で記述された日本語文字列が**コンパイル時に破壊**される。警告 C4819 が発生する:

```
warning C4819: ファイルは、現在のコード ページ (932) で表示できない文字を含んでいます。
データの損失を防ぐために、ファイルを Unicode 形式で保存してください。
```

## 実行手順

### DLLの配置

実行時に `gmp-10.dll` が必要。実行ファイルと同じディレクトリにコピーしておく:

```cmd
copy "C:\vcpkg\installed\x64-windows\bin\gmp-10.dll" C:\Users\cre\mpi01\
```

DLLがない場合、プログラムは何も出力せず即座に終了する。

### コンソールのコードページ設定

日本語を正しく表示するため、実行前にコードページをUTF-8に変更する。
シェルによって設定方法が異なる。

**cmd.exe の場合:**
```cmd
chcp 65001
```

**PowerShell の場合:**

`chcp 65001` だけでは不十分。PowerShell独自のエンコーディング設定が必要:
```powershell
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

### 実行コマンド（ローカル）

```cmd
:: 100桁（4プロセス）
mpiexec -n 4 pi_bbp_mpi.exe 100

:: 1000桁
mpiexec -n 4 pi_bbp_mpi.exe 1000

:: 結果をファイルに保存
mpiexec -n 4 pi_bbp_mpi.exe 100 > result.txt
```

### 分散実行（複数PC）

MS-MPIで複数PCに分散実行するには `-machinefile` オプションを使用する。

**注意: `-hostfile` はMS-MPIでは使用できない。** `-hostfile` はOpenMPI のオプションであり、MS-MPIの `mpiexec` では `Unknown option` エラーとなる。

```cmd
:: 誤（OpenMPI形式）
mpiexec -hostfile hostfile.txt pi_bbp_mpi.exe        ← エラー

:: 正（MS-MPI形式）
mpiexec -n 8 -machinefile hostfile.txt pi_bbp_mpi.exe
```

#### machinefile のフォーマット

MS-MPIの `-machinefile` はOpenMPIの `-hostfile` とファイル形式が異なる。**ホスト名（またはIP）のみを1行ずつ記述**し、プロセス数は `-n` オプションで指定する。

```
# OpenMPI の hostfile 形式（MS-MPIでは使用不可）
192.168.1.10:4
192.168.1.20:4

# MS-MPI の machinefile 形式（正しい書式）
192.168.1.10
192.168.1.20
```

machinefile の例（`hostfile.txt`）:
```
172.22.25.179
172.22.25.182
```

実行例:
```cmd
mpiexec -n 8 -machinefile hostfile.txt pi_bbp_mpi.exe 100
```

#### CPUコアをフルに使う実行方法

`-n` だけではデフォルトのアフィニティ設定により、全コアが使われない場合がある。
`-affinity` オプションでアフィニティ設定を無効化することで全コアを使用できる。

例: 物理コア16（論理コア24）のマシン2台の場合

```cmd
:: 物理コア数で実行（推奨）: 16コア × 2台 = 32プロセス
mpiexec -n 32 -affinity -machinefile hostfile.txt pi_bbp_mpi.exe 1000

:: 論理コア数で実行: 24コア × 2台 = 48プロセス
mpiexec -n 48 -affinity -machinefile hostfile.txt pi_bbp_mpi.exe 1000
```

BBP公式のような演算主体の処理ではハイパースレッディングの効果は薄く、
物理コア数に合わせた方が速い場合が多い。両方試して比較するのが確実。

**注意:** `-ppn`（processes per node）オプションはMS-MPIではエラーとなり使用できない。

#### 分散実行の前提条件

接続先の各PCに以下が必要:
- MS-MPIランタイムがインストールされていること
- MS-MPI Launch Service (`MsMpiLaunchSvc`) が起動していること
- 同じパスに実行ファイル (`pi_bbp_mpi.exe`) と `gmp-10.dll` が配置されていること

### 実行結果の例

```
=== BBP公式によるMPI並列円周率計算 ===
プロセス数: 4
計算桁数: 100
計算項数: 110
GMP精度: 414 ビット

計算結果:
3.1415926535 8979323846 2643383279 5028841971 6939937510
  5820974944 5923078164 0628620899 8628034825 3421170680

計算時間: 0.XXX 秒
```

## トラブルシューティング

| 症状 | 原因 | 対処 |
|---|---|---|
| `cl` が見つからない | 通常の `cmd.exe` から実行している | Developer Command Prompt for VS 2022 を使用する |
| 警告 C4819 + 実行時文字化け | `/utf-8` フラグが未指定 | コンパイル時に `/utf-8` を追加する |
| 実行しても何も出力されない | `gmp-10.dll` が見つからない | DLLを実行ファイルと同じディレクトリにコピーする |
| 日本語が文字化けする（cmd.exe） | コンソールのコードページがCP932 | `chcp 65001` でUTF-8に変更する |
| 日本語が文字化けする（PowerShell） | PowerShellの出力エンコーディングがCP932 | `[Console]::OutputEncoding = [System.Text.Encoding]::UTF8` を実行する |
| `Unknown option: -hostfile` | MS-MPIは `-hostfile` 未対応 | `-machinefile` を使用する |
| `mpiexec` が見つからない | MS-MPIランタイム未インストール | [MS-MPI](https://learn.microsoft.com/ja-jp/message-passing-interface/microsoft-mpi)をインストールする |
| 分散実行で `error 1722` | machinefile に `ホスト名:プロセス数` 形式で記述している | ホスト名のみを1行ずつ記述し、プロセス数は `-n` で指定する |
| 分散実行で `exit code 0xc0000135` | 接続先PCにDLLがない | 接続先にも `pi_bbp_mpi.exe` と `gmp-10.dll` を同じパスに配置する |

## ファイル構成（ビルド後）

```
C:\Users\cre\mpi01\
├── pi_bbp_mpi.c        # ソースコード
├── pi_bbp_mpi.exe      # 実行ファイル（cl で生成）
├── pi_bbp_mpi.obj      # オブジェクトファイル（cl で生成）
└── gmp-10.dll           # GMP ランタイムDLL（vcpkgからコピー）
```
